<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src="https://d3js.org/d3-array.v2.min.js"></script>
<script type="text/javascript", src="./js/d3/d3.js"></script>
<style>
.plotbutton{
  background-color: #4CAF50
}
</style>
</head>
<body>
<h2>Histogram chart for LSST OpSims</h2>
<p>Click line to highlight, double click to cancel. Click the legend dots to select families. Mouseover legend text to preview. Mouseleave legend text to clear selections.</p>

<div class="slider item">
      <div id="selected_nbins">number of bins </div>
      <div><span class="low">10</span> 
           <input type="range" id='nbins_slider' name="scale" min="10" max="100" step='1' value="50"> 
           <span>100</span></div>
</div>
<button class="button" onclick = "update()">Update</button>

  <table>
    <tr>
    <th> <div id="hist"></div> </th>
    <th> <div id="rank"></div> </th>
    </tr>
    <tr>
    <th> <div id="skymap"></div></th>
    </tr>>
  </table>

<script type="text/javascript">
var width = 900
var height = 800

var margin = {top: 70, right: 70, bottom: 70, left: 70},
    w = width - margin.left - margin.right,
    h = height - margin.top - margin.bottom;

var  centerXPos = w / 2 + margin.left;
var  centerYPos = h / 2 + margin.top;

var svg = d3.select("#hist").append("svg")
    .attr("width", w + margin.left + margin.right)
    .attr("height", h + margin.top + margin.bottom)
    .style("background-color", "#f7f7f7f7")
    .append("g")
    .attr("transform", "translate(" + margin.left +", "+ margin.top +")")

// add axis label
svg.append("text").attr("text-anchor", "end")
   .attr("x", width/2)
   .attr("y",  height-margin.bottom-20)
   .text("recovery rate")

svg.append("text").attr("text-anchor", "center")
   .attr("transform", "rotate(-90)")
   .attr("y", -margin.left + 20)
   .attr("x", margin.top - height/2 + 20)
   .text("N (healpix nside=16)")

svg.append("text").attr("text-anchor", "end")
   .attr("transform", "rotate(-90)")
   .attr("y", -margin.left + width - 20)  // actual x because of rotation
   .attr("x", margin.top - height/2 + 50)
   .text("N cumulative")


var svg2 = d3.select("#rank").append("svg")
    .attr("width", 500 + margin.left + margin.right)
    .attr("height", h + margin.top + margin.bottom)
    .style("background-color", "#f7f7f7f7")
    .append("g")
    .attr("transform", "translate(" + margin.left +", "+ margin.top +")")

//var color = d3.scale.category10(); // use in d3.v3
//var color = d3.scaleOrdinal(d3.schemeCategory10) // in > d3.v4

//families = [ '#a6cee3', '#1f78b4', '#b2df8a', '#33a02c', '#fb9a99', '#e31a1c', '#fdbf6f', '#ff7f00', '#cab2d6', '#6a3d9a', '#ffff99', '#b15928', '#004301', '#5e0022', '#ed00d7', '#00008f', '#626d60', '#9978ff', '#5b3600', '#00a799']
//families = ['#a6cee3','#1f78b4','#1f78b4','#b2df8a','#b2df8a','#b2df8a','#33a02c','#33a02c','#33a02c','#33a02c','#33a02c','#33a02c','#fb9a99','#e31a1c','#e31a1c','#e31a1c','#e31a1c','#e31a1c','#e31a1c','#fdbf6f','#ff7f00','#ff7f00','#ff7f00','#ff7f00','#ff7f00','#ff7f00','#ff7f00','#ff7f00','#cab2d6','#cab2d6','#cab2d6','#cab2d6','#cab2d6','#cab2d6','#cab2d6','#cab2d6','#cab2d6','#cab2d6','#cab2d6','#cab2d6','#6a3d9a','#6a3d9a','#6a3d9a','#6a3d9a','#6a3d9a','#ffff99','#b15928','#004301','#004301','#004301','#004301','#004301','#004301','#5e0022','#5e0022','#5e0022','#5e0022','#ed00d7','#00008f','#00008f','#00008f','#00008f','#00008f','#00008f','#626d60','#626d60','#626d60','#626d60','#9978ff','#5b3600','#00a799','#00a799','#00a799','#00a799','#00a799','#00a799','#00a799','#00a799','#00a799','#00a799','#00a799','#00a799','#00a799','#00a799','#00a799','#00a799']

// colors
families = ['#00008f','#00008f','#00008f','#004301','#004301','#00a799','#00a799','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1F87A7','#1f78b4','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#2A0319','#33a02c','#46982C','#5b3600','#5b3600','#5b3600','#5b3600','#5b3600','#5b3600','#5b3600','#5b3600','#5b3600','#5e0022','#5e0022','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60','#626d60']

//var variables = ["variable 1", "variable 2"]
var variables = ['baseline_nexp2_v1_7_1_10yrs',
 'baseline_retrofoot_v2_0_10yrs',
 'baseline_v2_0_10yrs',
 'bluer_indx0_v2_0_10yrs',
 'bluer_indx1_v2_0_10yrs',
 'ddf_frac_ddf_per0_6_v2_0_10yrs',
 'ddf_frac_ddf_per1_6_v2_0_10yrs',
 'long_gaps_nightsoff0_delayed-1_v2_0_10yrs',
 'long_gaps_nightsoff0_delayed1827_v2_0_10yrs',
 'long_gaps_nightsoff1_delayed-1_v2_0_10yrs',
 'long_gaps_nightsoff1_delayed1827_v2_0_10yrs',
 'long_gaps_nightsoff2_delayed-1_v2_0_10yrs',
 'long_gaps_nightsoff2_delayed1827_v2_0_10yrs',
 'long_gaps_nightsoff3_delayed-1_v2_0_10yrs',
 'long_gaps_nightsoff3_delayed1827_v2_0_10yrs',
 'long_gaps_nightsoff4_delayed-1_v2_0_10yrs',
 'long_gaps_nightsoff4_delayed1827_v2_0_10yrs',
 'long_gaps_nightsoff5_delayed-1_v2_0_10yrs',
 'long_gaps_nightsoff5_delayed1827_v2_0_10yrs',
 'long_gaps_nightsoff6_delayed-1_v2_0_10yrs',
 'long_gaps_nightsoff6_delayed1827_v2_0_10yrs',
 'long_gaps_nightsoff7_delayed-1_v2_0_10yrs',
 'long_gaps_nightsoff7_delayed1827_v2_0_10yrs',
 'long_gaps_np_nightsoff0_delayed-1_v2_0_10yrs',
 'long_gaps_np_nightsoff0_delayed1827_v2_0_10yrs',
 'long_gaps_np_nightsoff1_delayed-1_v2_0_10yrs',
 'long_gaps_np_nightsoff1_delayed1827_v2_0_10yrs',
 'long_gaps_np_nightsoff2_delayed-1_v2_0_10yrs',
 'long_gaps_np_nightsoff2_delayed1827_v2_0_10yrs',
 'long_gaps_np_nightsoff3_delayed-1_v2_0_10yrs',
 'long_gaps_np_nightsoff3_delayed1827_v2_0_10yrs',
 'long_gaps_np_nightsoff4_delayed-1_v2_0_10yrs',
 'long_gaps_np_nightsoff4_delayed1827_v2_0_10yrs',
 'long_gaps_np_nightsoff5_delayed-1_v2_0_10yrs',
 'long_gaps_np_nightsoff5_delayed1827_v2_0_10yrs',
 'long_gaps_np_nightsoff6_delayed-1_v2_0_10yrs',
 'long_gaps_np_nightsoff6_delayed1827_v2_0_10yrs',
 'long_gaps_np_nightsoff7_delayed-1_v2_0_10yrs',
 'long_gaps_np_nightsoff7_delayed1827_v2_0_10yrs',
 'long_u1_v2_0_10yrs',
 'long_u2_v2_0_10yrs',
 'noroll_v2_0_10yrs',
 'presto_gap1_5_mix_v2_0_10yrs',
 'presto_gap1_5_v2_0_10yrs',
 'presto_gap2_0_mix_v2_0_10yrs',
 'presto_gap2_0_v2_0_10yrs',
 'presto_gap2_5_mix_v2_0_10yrs',
 'presto_gap2_5_v2_0_10yrs',
 'presto_gap3_0_mix_v2_0_10yrs',
 'presto_gap3_0_v2_0_10yrs',
 'presto_gap3_5_mix_v2_0_10yrs',
 'presto_gap3_5_v2_0_10yrs',
 'presto_gap4_0_mix_v2_0_10yrs',
 'presto_gap4_0_v2_0_10yrs',
 'presto_half_gap1_5_mix_v2_0_10yrs',
 'presto_half_gap1_5_v2_0_10yrs',
 'presto_half_gap2_0_mix_v2_0_10yrs',
 'presto_half_gap2_0_v2_0_10yrs',
 'presto_half_gap2_5_mix_v2_0_10yrs',
 'presto_half_gap2_5_v2_0_10yrs',
 'presto_half_gap3_0_mix_v2_0_10yrs',
 'presto_half_gap3_0_v2_0_10yrs',
 'presto_half_gap3_5_mix_v2_0_10yrs',
 'presto_half_gap3_5_v2_0_10yrs',
 'presto_half_gap4_0_mix_v2_0_10yrs',
 'presto_half_gap4_0_v2_0_10yrs',
 'retro_baseline_v2_0_10yrs',
 'roll_early_v2_0_10yrs',
 'rolling_all_sky_ns2_rw0_9_v2_0_10yrs',
 'rolling_bulge_6_v2_0_10yrs',
 'rolling_bulge_ns2_rw0_5_v2_0_10yrs',
 'rolling_bulge_ns2_rw0_8_v2_0_10yrs',
 'rolling_bulge_ns2_rw0_9_v2_0_10yrs',
 'rolling_ns2_rw0_5_v2_0_10yrs',
 'rolling_ns2_rw0_9_v2_0_10yrs',
 'rolling_ns3_rw0_5_v2_0_10yrs',
 'rolling_ns3_rw0_9_v2_0_10yrs',
 'six_rolling_ns6_rw0_5_v2_0_10yrs',
 'six_rolling_ns6_rw0_9_v2_0_10yrs',
 'vary_expt_v2_0_10yrs',
 'vary_gp_gpfrac0_01_v2_0_10yrs',
 'vary_gp_gpfrac0_05_v2_0_10yrs',
 'vary_gp_gpfrac0_10_v2_0_10yrs',
 'vary_gp_gpfrac0_15_v2_0_10yrs',
 'vary_gp_gpfrac0_20_v2_0_10yrs',
 'vary_gp_gpfrac0_25_v2_0_10yrs',
 'vary_gp_gpfrac0_30_v2_0_10yrs',
 'vary_gp_gpfrac0_35_v2_0_10yrs',
 'vary_gp_gpfrac0_40_v2_0_10yrs',
 'vary_gp_gpfrac0_45_v2_0_10yrs',
 'vary_gp_gpfrac0_50_v2_0_10yrs',
 'vary_gp_gpfrac0_55_v2_0_10yrs',
 'vary_gp_gpfrac0_75_v2_0_10yrs',
 'vary_gp_gpfrac1_00_v2_0_10yrs',
 'vary_nes_nesfrac0_01_v2_0_10yrs',
 'vary_nes_nesfrac0_05_v2_0_10yrs',
 'vary_nes_nesfrac0_10_v2_0_10yrs',
 'vary_nes_nesfrac0_15_v2_0_10yrs',
 'vary_nes_nesfrac0_20_v2_0_10yrs',
 'vary_nes_nesfrac0_25_v2_0_10yrs',
 'vary_nes_nesfrac0_30_v2_0_10yrs',
 'vary_nes_nesfrac0_35_v2_0_10yrs',
 'vary_nes_nesfrac0_40_v2_0_10yrs',
 'vary_nes_nesfrac0_45_v2_0_10yrs',
 'vary_nes_nesfrac0_50_v2_0_10yrs',
 'vary_nes_nesfrac0_55_v2_0_10yrs',
 'vary_nes_nesfrac0_75_v2_0_10yrs',
 'vary_nes_nesfrac1_00_v2_0_10yrs']

var color = d3.scaleOrdinal(families).domain(variables)

//csvfile = './data/data_doubleHist.csv'
//csvfile = 'https://raw.githubusercontent.com/fedhere/LSSTunknowns/master/pmAnom/TPM.csv'

csvfile = './data/TPM_v20_10yrs.csv'

function update(){ 

      var nbins = document.querySelector("#nbins_slider").value
      console.log(nbins)
      d3.select("#selected_nbins").text('number of bins '+ nbins)

      
      d3.csv(csvfile).then( function(data){
      
      
        // X axis: scale and draw:
        var x = d3.scaleLinear()
            .domain([0, 0.5])     // can use this instead of 1000 to have the max of data: d3.max(data, function(d) {       return +d.price })
            .range([0, w]);
        svg.append("g")
            .attr("transform", "translate(0," + h + ")")
            .call(d3.axisBottom(x));
        // Y axis: scale and draw:
        var y = d3.scaleLinear()
                  .range([h, 0])
        
        
        // Y axis: right
        var y2 = d3.scaleLinear()
                    .range([h, 0])
                    .domain([0, 1850])
          svg.append("g").attr("transform", "translate("+w+", 0)")
                .call(d3.axisRight(y2))
      
        // set the parameters for the histogram
        var histogram = d3.histogram()
            .value(function(d) { return +d.values; })   // I need to give the vector of value
            .domain(x.domain())  // then the domain of the graphic
            .thresholds(x.ticks(nbins)); // then the numbers of bins

        for (var v=0;v<variables.length;v++){
            // And apply twice this function to data to get the bins.
            var bins1 = histogram(data.filter( function(d){return d.variable === variables[v]} ));
            

            y.domain([0, d3.max(bins1, function(d) { return d.length*1.2; })]);   // d3.hist has to be called before the Y axis obviously
            // update axis and path
            d3.select("#axisy").remove()
            d3.selectAll("."+variables[v]).remove()
            d3.selectAll(".cumpath"+variables[v]).remove()
            d3.selectAll("#dots"+variables[v]).remove()
            d3.selectAll(".legendtext"+variables[v]).remove()

            svg.append("g")
                .attr("id", "axisy")
                .call(d3.axisLeft(y));
      
            //console.log(bins1)
            // append the bars for series 1
            var length_cum = 0;
      
            svg.selectAll("rect"+v)
                .data(bins1)
                .enter()
                .append("g")
                .append("rect")
                  .attr('class', variables[v])
                  .attr("x", 1)
                  .attr("transform", function(d) { return "translate(" + x(d.x0) + "," + y(d.length) + ")"; })
                  .attr("width", function(d) { return x(d.x1) - x(d.x0); })
                  .attr("height", function(d, i) {
                                         //length_cum += d.length
                                    return h - y(d.length); 
                                })
                  .style("fill", families[v])
                  .style("opacity", 0.004)
      
            // add line
            var linedata = [ {"linex":0, "liney":0 + v },
                    {"linex":0.1, "liney":10 + v },
                    {"linex":0.2, "liney":50 + v },]
      
            var h_cum = 0;
      
            var line = d3.line().x(function(d){return x(d.x0)}) 
                                .y(function(d, i){
                                            h_cum += d.length
                                            //console.log([v, h_cum])
                                            return y2(h_cum)})
            
            svg.append("path")
               .datum(bins1)
               .attr("class", "cumpath"+variables[v])
               .attr("d",line)
               .style("stroke", color(variables[v])).style("stroke-width", 1)
               .style("fill", "none")
               .style("stroke-opacity", 0.2)
               .on("mouseover", function(d){
                  d3.select(this).style("stroke-width", 5).style("stroke-opacity", 1)
                      //d3.select("#"+d).style("stroke-opacity", 1)
                      tooltip.style("visibility", "visible")
                        .text( d3.select(this).attr("class").replace("cumpath", "") )
                        .style("top", (d3.event.pageY-10)+"px")
                        .style("left",(d3.event.pageX+10)+"px")
                        .style("opacity", 1) 
                        })
                .on("mouseleave", function(d){
                  d3.select(this).style("stroke-width", 1).style("stroke-opacity", 0.2)
                      //d3.select("#"+d).style("stroke-opacity", 0.1)
                         tooltip.style("visibility", "hidden")

               })

      
            // Handmade legend
            svg2.append("circle")
              .attr("cx", function(d,i){if (v>variables.length/2){return 300-10} else {return 0} })
              .attr("cy", function(d,i){ if (v<=variables.length/2){return v*12} else {return (v-variables.length/2)*12} })      
              .attr("r", 5)
              .attr("id", "dots"+variables[v] )
              .style("fill", families[v] )
              .on("mouseover", function(d){
                          d3.select("#dots"+d).attr("r", 8) 
                        })
              .on("mouseleave", function(d){
                          d3.select("#dots"+d).attr("r", 5) 


                        })
              .on("click", function(d){  
                          d3.select(this).style("opacity", 1).style("stroke-width", 4)
                                  .style("stroke", "black").style("stroke-opacity", 1)
                          // Second the hovered specie takes its color
                          tex = this.id.replace("dots","")
                          console.log( tex )
      
                          d3.selectAll("." +  tex)
                            .style("opacity", 0.5)//.style("stroke-width", "2")
                            //.style("fill", "#f7f7f7f7")
                            //.style("stroke", color(tex)).style("stroke-opacity", 1)
                          
                          d3.selectAll('.cumpath'+tex)
                                      .style("stroke-width", "3")
                                      //.style("fill", "#f7f7f7f7")
                                      .style("stroke-opacity", 1)
      
                          //.transition().duration(200)
                          //.style("stroke", color(d))
                               } )
      
            svg2.append("text")
                .attr("class", "legendtext"+variables[v])
                .attr("x", function(){
                              if (v<= variables.length/2) {return 10} else {return 300}  
                                    })
      
                .attr("y", function(){
                              if (v<= variables.length/2) {return v*12} else {return (v-variables.length/2)*12} 
                                    })
                .text(variables[v]).style("font-size", "12px")
                .attr("alignment-baseline","middle")
                .on("mouseover", function(){
                                    var tex = d3.select(this).text()
                                    console.log(tex)
      
                                    d3.selectAll('.'+tex)
                                      .style("opacity", 0.5).style("stroke-width", "0")
                                      //.style("fill", "#f7f7f7f7")
                                      .style("stroke", color(tex)).style("stroke-opacity", 1)
      
                                    d3.selectAll('.cumpath'+tex)
                                      .style("stroke-width", "3")
                                      //.style("fill", "#f7f7f7f7")
                                      .style("stroke-opacity", 1)
      
      
                                    })
                .on("mouseleave", function(){
                                    var tex = d3.select(this).text()
                                    console.log(tex)
      
                                    d3.selectAll('.'+tex)
                                      .style("opacity", 0.004).style("stroke-opacity", 0)
      
                                    d3.selectAll('.cumpath'+tex)
                                      .style("stroke-width", "1")
                                      //.style("fill", "#f7f7f7f7")
                                      .style("stroke-opacity", 0.2)

                                    d3.select("#dots"+tex).attr("r", 5).style("stroke-opacity", 0)
      
      
                                    })
      
        }
      
      })
}

//add a tooltip
var tooltip = d3.select("body").append("div")
    .style("position", "absolute")
    .style("z-index", "10")
    .style("visibility", "hidden")
    .style("background", "white" )
    .style("opacity", 0.6)

update()

</script>

</body>
</html>

